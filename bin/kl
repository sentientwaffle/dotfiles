#!/bin/sh -eu

# usage:
# $ kl
# $ kl -f <pod>
# $ kl -f -lapp=<app>

# "kubectl log" helper.

# Don't fail when there are multiple containers.
all='--all-containers=true'
# Don't fail when there are too many log streams (pods).
max='--max-log-requests=14'

if [ $# != 0 ]; then
	kubectl logs "$all" "$max" "$@" | cl
	exit
fi

kube_app_labels() {
	kubectl get pods -o \
		jsonpath='{.items[*].metadata.labels.app}' \
		| sed 's/ /\n/g' \
		| sort \
		| uniq
}

labels=$(kube_app_labels)
pods=$(kubectl get pods -o name)
pod_or_app=$(printf '%s%s' "$labels" "$pods" | fzy)

case "$pod_or_app" in
	pod/*) kubectl logs "$all" "$max" -f       "$pod_or_app" | cl ;;
	*)     kubectl logs "$all" "$max" -f -lapp="$pod_or_app" | cl ;;
esac
