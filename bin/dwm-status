#!/usr/bin/env bash
# Update DWM's status bar.

refresh=10
count=0
mic=""
bat=""
charging=""
con=""
lock=""
used_root=""
used_home=""
ram=""
cpu=""
cpus=$(nproc)

net_down_last=0
net_up_last=0
net_return=""

get_disk_used() {
	local partition=$1
	df -h | grep -o "[0-9]\+% $partition$" | cut -d' ' -f1
}

get_ram() {
	# TODO /proc/meminfo: MemAvailable / MemTotal
	free | awk '/Mem:/ {print 100*($2-$7)/$2}' | cut -d'.' -f1
}

get_cpu() {
	awk "{print \$1 * 100 / $cpus}" < /proc/loadavg | cut -d'.' -f1
}

get_netrate() {
	local prefix='/: /'
	local count='{ down += $2; up += $(NF-7) }'
	local end='END { print down " " up }'
	local net_now=$(awk "$prefix $count $end" < /proc/net/dev)
	local down_now=$(cut -d' ' -f1 <<< "$net_now")
	local up_now=$(cut -d' ' -f2 <<< "$net_now")

	((down_rate=(down_now - net_down_last) / refresh))
	((up_rate=(up_now - net_up_last) / refresh))

	net_down_last=$down_now
	net_up_last=$up_now
	net_return="↑$(numfmt --to=si "$up_rate") ↓$(numfmt --to=si "$down_rate")"
}

get_volume() {
	local vol=$(dwm-volume get)
	[[ "$vol" != 'mute' ]] && vol="vol=$vol"
	echo "$vol"
}

get_connection() {
	# Sort so that ethernet has precedence over wireless.
	# Exclude `vetha` and `bridge` so that docker interfaces dont show up.
	nmcli c show --active | grep -v ' bridge\| veth' | tail -n+2 | awk '{print $NF}' | sort | head -n1
}

get_battery() {
	# TODO: /sys/class/power_supply/BAT{0,1}/energy_{now,full}
	acpi | head -n1 | grep -o '[[:digit:]]*%'
}

get_charging() {
	local chargefile='/sys/class/power_supply/AC/online'
	if ! [[ -e "$chargefile" && $(cat "$chargefile") == '1' ]]; then
		echo '<span foreground="#e8332e">!</span>'
	fi
}

get_locked() {
	if [[ -e '/tmp/autolock' ]]; then
		echo '<span foreground="#e8332e">unlocked</span> '
	fi
}

while true; do
	if ((count == 0)); then
		mic=$(dwm-volume getmic)
		bat=$(get_battery)
		charging=$(get_charging)
		con=$(get_connection)
		lock=$(get_locked)
		used_root=$(get_disk_used '/')
		used_home=$(get_disk_used '/home')
		ram=$(get_ram)
		cpu=$(get_cpu)
		get_netrate
	fi
	title=$lock
	title=$title'<span foreground="#33aaff">'$(get_volume)'</span>'
	title=$title
	if [[ -n "$mic" ]]; then
		title=$title'<span foreground="#e8332e">!</span>'
	fi
	title=$title' <span foreground="#ffff00">/='$used_root'</span>'
	title=$title' <span foreground="#ffff00">/home='$used_home'</span>'
	title=$title' <span foreground="#ff3399">ram='$ram'%</span>'
	title=$title' <span foreground="#ff6600">cpu='$cpu'%</span>'
	title=$title' <span foreground="#33ffff">'$net_return'</span>'
	# TODO offline should be red
	title=$title' <span foreground="#33ffff">'${con:-offline}'</span>'
	title=$title' <span foreground="#00ff33">bat='$bat'</span>'$charging
	title=$title' <span foreground="#dddddd">'$(date +'%a %b %d %H:%M:%S')'</span>'

	xsetroot -name "$title"
	((count=(count + 1) % refresh))
	sleep 1
done
