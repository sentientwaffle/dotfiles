#!/usr/bin/env python2
"""

Print the number of unread messages.

"""

import imaplib
import re
import subprocess
from time import time
from sys import exit

TMP = "/tmp/tmux-gmail.txt"
USERNAME1 = "sentientwaffle"
USERNAME2 = "dj.gardiner@voxer.com"
EMAIL1 = "sentientwaffle@gmail.com"
EMAIL2 = "dj@voxer.com"
INTERVAL = 60
now = int(time())

def tmp(mode):
    """ Get the temp file. """
    return open(TMP, mode)


# Check if the mail needs checking.
try:
    before, count = tmp("r").read().split(":")
    # Just send the cached value back.
    if now - int(before) < INTERVAL:
        print count
        exit(0)
except IOError:
    pass


def get_passwd(name):
    """

    Get the gmail password.

    """
    return subprocess.check_output(["pass", "google/tmux/" + name])

def mailbox(username, password):
    """

    Connect to the server.

    """
    m = imaplib.IMAP4_SSL("imap.gmail.com", 993)
    m.login(username, password)
    m.select("Inbox", readonly = True)
    return m

def unread(m):
    """

    Check the mail for the number of unread messages.

    """
    _, res = m.status("Inbox", "(UNSEEN)")
    count = re.search("UNSEEN (\d+)", res[0]).group(1)
    return count

def save(count):
    """

    Cache the results.

    """
    tmp("w").write(str(now) + ":" + str(count))

passwd1 = get_passwd(EMAIL1)
passwd2 = get_passwd(EMAIL2)
if passwd1 == "" or passwd2 == "":
    print "?"
else:
    mail1 = mailbox(USERNAME1, passwd1)
    mail2 = mailbox(USERNAME2, passwd2)
    out = unread(mail1) + "," + unread(mail2)
    print out
    save(out)
