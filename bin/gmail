#!/usr/bin/env python
"""

Print the number of unread messages.

"""

import imaplib
import re
from time import time
from sys import exit
import gnomekeyring as gkey

TMP = "/tmp/tmux-gmail.txt"
USERNAME1 = "sentientwaffle"
USERNAME2 = "dj.gardiner@voxer.com"
INTERVAL = 60
now = int(time())

def tmp(mode):
    """ Get the temp file. """
    return open(TMP, mode)


# Check if the mail needs checking.
try:
    before, count = tmp("r").read().split(":")
    # Just send the cached value back.
    if now - int(before) < INTERVAL:
        print count
        exit(0)
except IOError:
    pass


def get_info(name):
    """

    Get the gmail password.

    """
    keyring = "login"
    info = None
    for item in gkey.list_item_ids_sync("login"):
        info = gkey.item_get_info_sync(keyring, item)
        if info.get_display_name() == name:
            break
    return info

def mailbox(username, password):
    """

    Connect to the server.

    """
    m = imaplib.IMAP4_SSL("imap.gmail.com", 993)
    m.login(username, password)
    m.select("Inbox", readonly = True)
    return m

def unread(m):
    """

    Check the mail for the number of unread messages.

    """
    _, res = m.status("Inbox", "(UNSEEN)")
    count = re.search("UNSEEN (\d+)", res[0]).group(1)
    return count

def save(count):
    """

    Cache the results.

    """
    tmp("w").write(str(now) + ":" + str(count))

info1 = get_info("Gmail")
info2 = get_info("GmailVox")
if info1 == None or info2 == None:
    print "?"
else:
    mail1 = mailbox(USERNAME1, info1.get_secret())
    mail2 = mailbox(USERNAME2, info2.get_secret())
    out = unread(mail1) + "," + unread(mail2)
    print out
    save(out)
